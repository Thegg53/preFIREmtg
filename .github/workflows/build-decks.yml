name: Build deck JSON

on:
  push:
    paths:
      - "lists/**"
      - "SCRIPTS/deckTextToJSON.py"
      - ".github/workflows/build-json.yml"
  workflow_dispatch: {}

permissions:
  contents: write   # needed to push commits

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # needed for push & accurate status
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate JSON
        id: generate
        run: |
          set -euo pipefail
          python SCRIPTS/deckTextToJSON.py INPUT/decklists
          DECKS_PATH="RESOURCES/data/lists/decks.json"
          ALL_CARDS_PATH="RESOURCES/data/lists/all_cards.json"
          echo "decks_path=${DECKS_PATH}" >> "$GITHUB_OUTPUT"
          echo "all_cards_path=${ALL_CARDS_PATH}" >> "$GITHUB_OUTPUT"

      - name: Show file location
        run: |
          echo "decks_path:      ${{ steps.generate.outputs.decks_path }}"
          echo "all_cards_path:  ${{ steps.generate.outputs.all_cards_path }}"
          ls -la "$(dirname "${{ steps.generate.outputs.decks_path }}")"

      - name: Git debug info
        run: |
          set -euo pipefail
          echo "pwd: $(pwd)"
          echo "branch (may be 'HEAD' if detached): $(git rev-parse --abbrev-ref HEAD)"
          echo "default branch from event: ${{ github.event.repository.default_branch }}"
          echo "ref name: ${{ github.ref_name }}"
          echo "Status:"
          git status --porcelain=v1
          echo "Check ignore rules for the JSON files:"
          git check-ignore -v RESOURCES/data/lists/decks.json || true
          git check-ignore -v RESOURCES/data/lists/all_cards.json || true
          echo "List target dir:"
          ls -la RESOURCES/data/lists
      
      - name: Commit JSON changes
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        env:
          TARGET_BRANCH: ${{ github.ref_name || github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
          # Stage only files that exist; force add in case .gitignore blocks them
          to_add=()
          [[ -f RESOURCES/data/lists/decks.json ]] && to_add+=("RESOURCES/data/lists/decks.json")
          [[ -f RESOURCES/data/lists/all_cards.json ]] && to_add+=("RESOURCES/data/lists/all_cards.json")
      
          if (( ${#to_add[@]} )); then
            git add -f "${to_add[@]}"
          fi
      
          if ! git diff --cached --quiet; then
            # Ensure we push to the actual branch even when HEAD is detached
            git commit -m "chore: update lists JSON"
            git pull --rebase origin "$TARGET_BRANCH"
            git push origin HEAD:"$TARGET_BRANCH"
            echo "Pushed to $TARGET_BRANCH"
          else
            echo "No changes to commit."
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: decks-json
          path: ${{ steps.generate.outputs.decks_path }}
          if-no-files-found: error
